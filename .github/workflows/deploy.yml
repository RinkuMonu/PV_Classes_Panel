name: Deploy Vite React Frontend to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ›  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install deps & build (Vite)
        run: |
          npm install --legacy-peer-deps
          npm run build

          # Vite must output to dist/
          if [ ! -d "dist" ]; then
            echo "âŒ dist/ folder not found after build. Stopping."
            exit 1
          fi

          # Pack dist into a tarball we can upload
          tar -czvf frontend_build.tar.gz -C dist .

      - name: ðŸ”‘ Write SSH key to file
        run: |
          echo "${{ secrets.REACT_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: ðŸš€ Upload bundle to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REACT_SSH_HOST }}
          username: ${{ secrets.REACT_SSH_USER }}
          port: ${{ secrets.REACT_SSH_PORT }}
          key: ${{ secrets.REACT_SSH_KEY }}
          source: "frontend_build.tar.gz"
          target: "${{ secrets.REACT_DEPLOY_DIR }}/"

      - name: ðŸ” SSH into EC2 and deploy to public_html
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REACT_SSH_HOST }}
          username: ${{ secrets.REACT_SSH_USER }}
          port: ${{ secrets.REACT_SSH_PORT }}
          key: ${{ secrets.REACT_SSH_KEY }}
          script: |
            set -e

            DEPLOY_DIR="${{ secrets.REACT_DEPLOY_DIR }}"
            LIVE_DIR="$DEPLOY_DIR/public_html"
            RELEASE_TAR="$DEPLOY_DIR/frontend_build.tar.gz"
            BACKUP_DIR="$DEPLOY_DIR/backup_frontend"
            TS=$(date +%Y%m%d_%H%M%S)

            echo "ðŸ“‚ Ensure public_html exists"
            mkdir -p "$LIVE_DIR"

            echo "ðŸ’¾ Creating backup $BACKUP_DIR/site_$TS"
            mkdir -p "$BACKUP_DIR"
            cp -r "$LIVE_DIR" "$BACKUP_DIR/site_$TS" || true

            echo "ðŸ§¹ Cleaning old static files from $LIVE_DIR"
            rm -rf "$LIVE_DIR"/*

            echo "ðŸ“¦ Extracting new dist -> $LIVE_DIR"
            tar -xzvf "$RELEASE_TAR" -C "$LIVE_DIR"

            echo "ðŸ—‘ Removing uploaded tar from server"
            rm -f "$RELEASE_TAR"

            echo "âœ… Frontend deployed at $LIVE_DIR"
